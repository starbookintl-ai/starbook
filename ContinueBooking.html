<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>StarBook | Continue Booking</title>
<link rel="stylesheet" href="styles/translucent.css">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', sans-serif}
  body{background:#f5f6fb;color:#222;overflow-x:hidden}

  .navbar{box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:12px 20px;position:sticky;top:0;z-index:20;background:rgba(255,255,255,0.6);backdrop-filter:blur(6px)}
  .navbar img{height:30px;object-fit:contain}

  .page-header{width:100%;max-width:1200px;margin:26px auto 12px;padding:0 20px}
  .page-header h2{color:black;font-size:22px;margin-bottom:8px}
  .page-header p{color:#555;font-size:14px}

  .main{width:100%;max-width:1200px;margin:18px auto;padding:0 20px;display:grid;grid-template-columns:  2.5fr 1fr;gap:20px;align-items:flex-start}


  .left-col{background:#fff;border-radius:12px;padding:22px;box-shadow:0 6px 22px rgba(0,0,0,0.06)}
  .section-title{color:#303030;font-size:18px;margin-bottom:14px}
  .details-list{display:flex;flex-direction:column;gap:12px}
  .detail-item{background:#fafafa;border:1px solid #ececec;border-radius:10px;padding:12px}
  .detail-item .subject{font-weight:700;color:#444;font-size:13px;margin-bottom:6px}
  .detail-item .body{color:#222;font-size:15px}

  .right-col{min-width:300px}
  .floating-card{position:sticky;top:86px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,0.08)}
  .floating-card h3{margin-bottom:12px}

  .steps{display:flex;flex-direction:column;gap:18px}
  .step{display:flex;align-items:flex-start;gap:12px;position:relative}
  .step .circle{width:34px;height:34px;border-radius:50%;border:2px solid #111;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  .step .label{flex:1}

  .methods{display:grid;gap:10px;margin-top:6px; grid-template-columns: 1fr 1fr 1fr 1fr;}
  .method-btn{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;opacity:0.5;animation:blink 1.6s infinite alternate}
  .method-btn .name{flex:1;text-align:left}
  .method-btn .selected-indicator{width:28px;height:28px;border-radius:50%;background:#fff;border:2px solid #000;display:flex;align-items:center;justify-content:center;font-weight:700;visibility:hidden}
  .method-btn.active{background:#000;color:#fff;border-color:#000;opacity:1;animation:none}
  .method-btn.active .selected-indicator{visibility:visible;background:#fff;color:#000}
  .method-btn.active .selected-indicator::after{content:'âœ“';font-size:14px}

  @keyframes blink { 0% {opacity:0.5} 100% {opacity:1} }

  .instructions{margin-top:14px;padding:12px;border-radius:8px;border:1px dashed #e6e6e6;background:#faf9ff;min-height:64px;opacity:1;animation:shine 1.6s infinite alternate}


  .copy-btn{background:#111;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;opacity:0.8}
  .copy-btn:disabled{opacity:0.5;cursor:not-allowed}

  .upload-box {
    margin-top:12px;
    border:2px dashed #bbb;
    background:#fafafa;
    border-radius:12px;
    height:120px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    position:relative;
    text-align:center;
    font-size:14px;
    color:#666;
  }
  .upload-box img {
    max-height:60px;
    max-width:60px;
    pointer-events:none;
    margin-bottom:6px;
  }
  .upload-box input[type=file] {
    position:absolute;
    width:100%;
    height:100%;
    opacity:0;
    cursor:pointer;
  }

  .upload-status {
    margin-top:8px;
    font-size:13px;
    padding:6px 10px;
    border-radius:6px;
    display:inline-block;
    min-width:180px;
  }
  .upload-status.success{background:#d1ffe862;color:#02ad57;border:1px solid #18e780;}
  .upload-status.error{background:#fdecea;color:#b22222;border:1px solid #b22222;}
    @media(max-width:900px){.main{grid-template-columns:1fr}
     .methods{grid-template-columns: 1fr 1fr; }}
    @media(max-width:400px){.methods{max-width:100px;} .method-btn{gap: 8px; padding: 10px 8px}}
</style>
</head>
<body>
<div class="navbar frost-fog" id="navbar"><img src="images/starbook_row_large_icon.png" alt="StarBook Logo"></div>

<div class="page-header">
  <h2>Secure Your Booking Reservation</h2>
  <p>Verify booking details and complete payment to finalize your reservation.</p>
</div>

<div class="main">

    <div class="right-col">
    <div class="floating-card">
      <h3>Payment Steps</h3>
      <div class="steps">
        <div class="step" id="step1">
          <div class="circle">1</div>
          <div class="label">
            <div style="font-weight:700">Select Payment Method</div>
            <div style="font-size:13px;color:#666">Choose how you'd like to pay</div>
            <div class="methods" id="methods">
              <button class="method-btn" data-method="PayPal"><span class="name">PayPal</span><span class="selected-indicator" aria-hidden="true"></span></button>
              <button class="method-btn" data-method="Bank Transfer"><span class="name">Bank transfer</span><span class="selected-indicator" aria-hidden="true"></span></button>
              <button class="method-btn" data-method="USDT/crypto"><span class="name">USDT / Crypto</span><span class="selected-indicator" aria-hidden="true"></span></button>
              <button class="method-btn" data-method="Gift Card"><span class="name">Gift card</span><span class="selected-indicator" aria-hidden="true"></span></button>
            </div>
            <div id="methodInstructions" class="instructions">Loading instructions...</div>
          </div>
        </div>

        <hr style="color: #555; margin: 20px 30px;">


        <div class="step" id="step2">
          <div class="circle">2</div>
          <div class="label">
            <div style="font-weight:700">Upload Receipt</div>
            <div style="font-size:13px;color:#666">Upload your payment receipt (JPG/PNG/GIF/PDF).</div>

            <div class="upload-box" id="uploadBox">
              <input type="file" id="fileInput" accept="image/*,.pdf">
              <img id="fileIcon" src="images/upload_icon.png" alt="Select file">
              <div id="fileName">Select a file</div>
            </div>

            <div style="margin-top:12px">
              <button id="uploadBtn" class="copy-btn" disabled>Upload Receipt</button>
            </div>
            <div id="uploadStatus" class="upload-status" aria-live="polite"></div>
          </div>
        </div>

        <hr style="color: #555; margin: 20px 30px;">

        <div class="step" id="step3">
          <div class="circle">3</div>
          <div class="label">
            <div style="font-weight:700">Await Verification</div>
            <div style="font-size:13px;color:#666">Our team will verify the payment and confirm your booking via email.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="left-col">
    <div class="section-title"><b>Booking Details</b></div>
    <div id="bookingDetails" class="details-list">Fetching booking...</div>
  </div>

</div>

<script>
const BOOKING_API = "https://script.google.com/macros/s/AKfycbw_PIwFbnWRghBd9mh--m7P2-LEYi24j5R_KfiS87ZT89U0W6k3SjOHSrC3Sny9O79m/exec";
const PAYMENT_API = "https://script.google.com/macros/s/AKfycbzROS6vsRs3Sh9O0-DE-bav4gWYY6ZIADJVGe1YlNgg2J2X8i1PFspp0-Uyt7J_bbyK/exec";
const UPLOAD_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhSXlfDynhJqbGB389-0CFQjJQ0JWN_Zl2Zj36V6MRF7sD0taB1T75AFHV6-Sdh0pt/exec';

const IMAGE_ICON = "images/image_icon.png";
const PDF_ICON = "images/pdf_icon.png";
const DEFAULT_ICON = "images/upload_icon.png";

let bookingData = null;
let methodInstructions = {};
const adminEmail = 'starbook.intl@gmail.com';

function renderBookingDetails(data) {
  const container = document.getElementById('bookingDetails');
  const items = [
    ['Booking Reference', data.ref],
    ['Name', data.name],
    ['Celebrity', data.celebName],
    ['Scheduled Date', data.scheduledDate],
    ['Event Type', data.eventType],
    ['Class', data.eventClass],
    ['Estimated Price', `$${Number(data.bookingPrice).toLocaleString()}`]
  ];
  container.innerHTML = '';
  items.forEach(([subject, value]) => {
    const node = document.createElement('div');
    node.className = 'detail-item';
    node.innerHTML = `<div class='subject'>${subject}</div><div class='body'>${value ?? '-'}</div>`;
    container.appendChild(node);
  });

  document.getElementById('uploadBtn').disabled = true;
}

// Payment method selection
const methodButtons = Array.from(document.querySelectorAll('.method-btn'));
const methodsOrder = ['PayPal','Bank Transfer','USDT/crypto','Gift Card'];

function setActiveMethod(btn) {
  methodButtons.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const method = btn.dataset.method;
  const info = document.getElementById('methodInstructions');
  const details = methodInstructions[method];

  const amountText = bookingData
    ? `$${Number(bookingData.bookingPrice).toLocaleString()}`
    : '';

  info.innerHTML = details
    ? `<div>
         <strong>${method} (Pay - ${amountText})</strong>
         <div style='margin-top:8px;white-space:pre-wrap'>${details}</div>
       </div>`
    : `<div style='color:#b22222'>${method} instructions unavailable.</div>`;
}

methodButtons.forEach(b => b.addEventListener('click', () => setActiveMethod(b)));

// File handling
const fileInput = document.getElementById('fileInput');
const fileIcon = document.getElementById('fileIcon');
const fileName = document.getElementById('fileName');
const uploadBtn = document.getElementById('uploadBtn');
const uploadStatus = document.getElementById('uploadStatus');

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if(!file) {
    fileIcon.src = DEFAULT_ICON;
    fileName.textContent = 'Select a file';
    uploadBtn.disabled = true;
    return;
  }

  const ext = file.name.split('.').pop().toLowerCase();
  if(!['jpg','jpeg','png','gif','pdf'].includes(ext)){
    alert('Only JPG, PNG, GIF images and PDF files are allowed.');
    fileInput.value = '';
    fileIcon.src = DEFAULT_ICON;
    fileName.textContent = 'Select a file';
    uploadBtn.disabled = true;
    return;
  }

  fileIcon.src = ext === 'pdf' ? PDF_ICON : IMAGE_ICON;
  fileName.textContent = file.name;
  uploadBtn.disabled = false;
});

function safe(obj, ...keys) {
  for (const k of keys) {
    if (obj && obj[k]) return String(obj[k]);
  }
  return null;
}

async function uploadSelectedFile() {
  const file = fileInput.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async () => {
    const b64 = reader.result.split(',')[1];

    const payload = {
      filename: file.name,
      mime: file.type || 'application/octet-stream',
      b64: b64,
      adminEmail: adminEmail,
      visitorName: safe(bookingData,'name'),
      visitorEmail: safe(bookingData,'email'),
      bookingId: safe(bookingData,'ref'),
      amount: safe(bookingData,'bookingPrice')
    };

    uploadStatus.textContent = 'Uploading...';

    try{
      const resp = await fetch(UPLOAD_SCRIPT_URL, {
        method:'POST',
        body:JSON.stringify(payload)
      });

      uploadStatus.className = 'upload-status success';
      uploadStatus.textContent =
        'Your receipt has successfully been uploaded for verification. Confirmation will be sent via email.';
    } catch(err){
      uploadStatus.className = 'upload-status error';
      uploadStatus.textContent = 'Upload failed.';
    }
  };
  reader.readAsDataURL(file);
}

uploadBtn.addEventListener('click', uploadSelectedFile);

// Fetch booking + preload instructions
const ref = new URLSearchParams(window.location.search).get('id');

function preloadInstructions() {
  return Promise.all(
    methodsOrder.map(method => {

      // ðŸ”§ FIX: match Google Sheet exactly
      let backendMethod = method;
      if (method === 'USDT/crypto') backendMethod = 'USDT/Crypto';

      return fetch(`${PAYMENT_API}?action=getPaymentDetails&method=${encodeURIComponent(backendMethod)}`)
        .then(r => r.json())
        .then(d => {
          methodInstructions[method] =
  d && d.success && d.details
    ? d.details
        .replace(/\r?\n+/g, ' ')   // remove line breaks
        .replace(/\s{2,}/g, ' ')   // collapse extra spaces
        .trim()
    : `${method} payment method unavailable.`;

        })
        .catch(() => {
          methodInstructions[method] = `${method} payment method unavailable.`;
        });
    })
  );
}

function fetchBooking() {
  if(!ref) return;

  return fetch(`${BOOKING_API}?id=${encodeURIComponent(ref)}`)
    .then(r=>r.json())
    .then(d=>{
      bookingData = d.booking;
      renderBookingDetails(bookingData);
    });
}

Promise.all([fetchBooking(), preloadInstructions()]).then(() => {
  const defaultBtn = methodButtons.find(b => b.dataset.method === 'PayPal');
  if (defaultBtn) setActiveMethod(defaultBtn);
});
</script>


</body>
</html>
