<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>StarBook | Continue Booking</title>
<link rel="stylesheet" href="styles/translucent.css">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', sans-serif}
  body{background:#f5f6fb;color:#222;overflow-x:hidden}

  .navbar{box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:12px 20px;position:sticky;top:0;z-index:20;background:rgba(255,255,255,0.6);backdrop-filter:blur(6px)}
  .navbar img{height:30px;object-fit:contain}

  .page-header{width:100%;max-width:1200px;margin:26px auto 12px;padding:0 20px}
  .page-header h2{color:black;font-size:22px;margin-bottom:8px}
  .page-header p{color:#555;font-size:14px}

  .main{width:100%;max-width:1200px;margin:18px auto;padding:0 20px;display:grid;grid-template-columns:1fr 1.5fr;gap:20px;align-items:flex-start}
  @media(max-width:900px){.main{grid-template-columns:1fr}}

  .left-col{background:#fff;border-radius:12px;padding:22px;box-shadow:0 6px 22px rgba(0,0,0,0.06)}
  .section-title{color:#303030;font-size:18px;margin-bottom:14px}
  .details-list{display:flex;flex-direction:column;gap:12px}
  .detail-item{background:#fafafa;border:1px solid #ececec;border-radius:10px;padding:12px}
  .detail-item .subject{font-weight:700;color:#444;font-size:13px;margin-bottom:6px}
  .detail-item .body{color:#222;font-size:15px}

  .right-col{min-width:300px}
  .floating-card{position:sticky;top:86px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,0.08)}
  .floating-card h3{margin-bottom:12px}

  .steps{display:flex;flex-direction:column;gap:18px}
  .step{display:flex;align-items:flex-start;gap:12px;position:relative}
  .step .circle{width:34px;height:34px;border-radius:50%;border:2px solid #111;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  .step .label{flex:1}

  .methods{display:flex;flex-direction:column;gap:10px;margin-top:6px}
  .method-btn{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;text-align:left;display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;opacity:0.5;animation:blink 1.6s infinite alternate}
  .method-btn .name{flex:1;text-align:left}
  .method-btn .selected-indicator{width:28px;height:28px;border-radius:50%;background:#fff;border:2px solid #000;display:flex;align-items:center;justify-content:center;font-weight:700;visibility:hidden}
  .method-btn.active{background:#000;color:#fff;border-color:#000;opacity:1;animation:none}
  .method-btn.active .selected-indicator{visibility:visible;background:#fff;color:#000}
  .method-btn.active .selected-indicator::after{content:'âœ“';font-size:14px}

  @keyframes blink { 0% {opacity:0.5} 100% {opacity:1} }

  .instructions{margin-top:14px;padding:12px;border-radius:8px;border:1px dashed #e6e6e6;background:#faf9ff;min-height:64px;opacity:0.5;animation:shine 1.6s infinite alternate}
  @keyframes shine { 0% {opacity:0.5} 100% {opacity:1} }

  .copy-btn{background:#111;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;opacity:0.8}
  .copy-btn:disabled{opacity:0.5;cursor:not-allowed}

  .upload-box {
    margin-top:12px;
    border:2px dashed #bbb;
    background:#fafafa;
    border-radius:12px;
    height:120px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    position:relative;
    text-align:center;
    font-size:14px;
    color:#666;
  }
  .upload-box img {
    max-height:60px;
    max-width:60px;
    pointer-events:none;
    margin-bottom:6px;
  }
  .upload-box input[type=file] {
    position:absolute;
    width:100%;
    height:100%;
    opacity:0;
    cursor:pointer;
  }

  .upload-status {
    margin-top:8px;
    font-size:13px;
    padding:6px 10px;
    border-radius:6px;
    display:inline-block;
    min-width:180px;
  }
  .upload-status.success{background:#d1ffe862;color:#02ad57;border:1px solid #18e780;}
  .upload-status.error{background:#fdecea;color:#b22222;border:1px solid #b22222;}
</style>
</head>
<body>
<div class="navbar frost-fog" id="navbar"><img src="images/starbook_row_large_icon.png" alt="StarBook Logo"></div>

<div class="page-header">
  <h2>Secure Your Booking Reservation</h2>
  <p>Verify booking details and complete payment to finalize your reservation.</p>
</div>

<div class="main">
  <div class="left-col">
    <div class="section-title">Booking Details</div>
    <div id="bookingDetails" class="details-list">Fetching booking...</div>
  </div>

  <div class="right-col">
    <div class="floating-card">
      <h3>Payment Steps</h3>
      <div class="steps">
        <div class="step" id="step1">
          <div class="circle">1</div>
          <div class="label">
            <div style="font-weight:700">Select Payment Method</div>
            <div style="font-size:13px;color:#666">Choose how you'd like to pay</div>
            <div class="methods" id="methods">
              <button class="method-btn" data-method="PayPal"><span class="name">PayPal</span><span class="selected-indicator" aria-hidden="true"></span></button>
              <button class="method-btn" data-method="Bank Transfer"><span class="name">Bank transfer</span><span class="selected-indicator" aria-hidden="true"></span></button>
              <button class="method-btn" data-method="USDT/crypto"><span class="name">USDT / Crypto</span><span class="selected-indicator" aria-hidden="true"></span></button>
              <button class="method-btn" data-method="Gift Card"><span class="name">Gift card</span><span class="selected-indicator" aria-hidden="true"></span></button>
            </div>
            <div id="methodInstructions" class="instructions">Loading instructions...</div>
          </div>
        </div>

        <hr style="color: #555; margin: 20px 30px;">

        <div class="step" id="step2">
          <div class="circle">2</div>
          <div class="label">
            <div style="font-weight:700">Upload Receipt</div>
            <div style="font-size:13px;color:#666">Upload your payment receipt (JPG/PNG/GIF/PDF).</div>

            <div class="upload-box" id="uploadBox">
              <input type="file" id="fileInput" accept="image/*,.pdf">
              <img id="fileIcon" src="images/upload_icon.png" alt="Select file">
              <div id="fileName">Select a file</div>
            </div>

            <div style="margin-top:12px">
              <button id="uploadBtn" class="copy-btn" disabled>Upload Receipt</button>
            </div>
            <div id="uploadStatus" class="upload-status" aria-live="polite"></div>
          </div>
        </div>

        <hr style="color: #555; margin: 20px 30px;">

        <div class="step" id="step3">
          <div class="circle">3</div>
          <div class="label">
            <div style="font-weight:700">Await Verification</div>
            <div style="font-size:13px;color:#666">Our team will verify the payment and confirm your booking via email.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const BOOKING_API = "https://script.google.com/macros/s/AKfycbw_PIwFbnWRghBd9mh--m7P2-LEYi24j5R_KfiS87ZT89U0W6k3SjOHSrC3Sny9O79m/exec";
const PAYMENT_API = "https://script.google.com/macros/s/AKfycbzROS6vsRs3Sh9O0-DE-bav4gWYY6ZIADJVGe1YlNgg2J2X8i1PFspp0-Uyt7J_bbyK/exec";
const UPLOAD_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhSXlfDynhJqbGB389-0CFQjJQ0JWN_Zl2Zj36V6MRF7sD0taB1T75AFHV6-Sdh0pt/exec';

const IMAGE_ICON = "images/image_icon.png"; // replace with your URL
const PDF_ICON = "images/pdf_icon.png"; // replace with your URL
const DEFAULT_ICON = "images/upload_icon.png";

let bookingData = null;
let methodInstructions = {};
const adminEmail = 'starbook.intl@gmail.com';

function renderBookingDetails(data) {
  const container = document.getElementById('bookingDetails');
  const items = [
    ['Booking Reference', data.ref],
    ['Name', data.name],
    ['Celebrity', data.celebName],
    ['Scheduled Date', data.scheduledDate],
    ['Event Type', data.eventType],
    ['Class', data.eventClass],
    ['Estimated Price', `$${Number(data.bookingPrice).toLocaleString()}`]
  ];
  container.innerHTML = '';
  items.forEach(([subject, value]) => {
    const node = document.createElement('div');
    node.className = 'detail-item';
    node.innerHTML = `<div class='subject'>${subject}</div><div class='body'>${value ?? '-'}</div>`;
    container.appendChild(node);
  });

  document.getElementById('uploadBtn').disabled = true;
}

// Payment method selection
const methodButtons = Array.from(document.querySelectorAll('.method-btn'));
const methodsOrder = ['PayPal','Bank Transfer','USDT/crypto','Gift Card'];
function setActiveMethod(btn) {
  methodButtons.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const method = btn.dataset.method;
  const info = document.getElementById('methodInstructions');
  const details = methodInstructions[method];
  info.innerHTML = details ? `<div><strong>${method} Instructions</strong><div style='margin-top:8px;white-space:pre-wrap'>${details}</div></div>` : `<div style='color:#b22222'>${method} instructions unavailable.</div>`;
}
methodButtons.forEach(b => b.addEventListener('click', () => setActiveMethod(b)));

// File selection handling
const fileInput = document.getElementById('fileInput');
const fileIcon = document.getElementById('fileIcon');
const fileName = document.getElementById('fileName');
const uploadBtn = document.getElementById('uploadBtn');
const uploadStatus = document.getElementById('uploadStatus');

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if(!file) {
    fileIcon.src = DEFAULT_ICON;
    fileName.textContent = 'Select a file';
    uploadBtn.disabled = true;
    return;
  }

  const ext = file.name.split('.').pop().toLowerCase();
  if(!['jpg','jpeg','png','gif','pdf'].includes(ext)){
    alert('Only JPG, PNG, GIF images and PDF files are allowed.');
    fileInput.value = '';
    fileIcon.src = DEFAULT_ICON;
    fileName.textContent = 'Select a file';
    uploadBtn.disabled = true;
    return;
  }

  fileIcon.src = ext === 'pdf' ? PDF_ICON : IMAGE_ICON;
  fileName.textContent = file.name;
  uploadBtn.disabled = false;
});

// --- Helper to read bookingData fields safely ---
function safe(obj, ...keys) {
  for (const k of keys) {
    if (!obj) continue;
    if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') return String(obj[k]);
  }
  return null;
}

// Upload function (modified to include visitor/booking fields)
async function uploadSelectedFile() {
  const file = fileInput.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async () => {
    const b64 = reader.result.split(',')[1];

    // gather visitor/booking fields (best-effort)
    const visitorName = bookingData ? safe(bookingData, 'name', 'fullName', 'visitorName') : null;
    const visitorEmail = bookingData ? safe(bookingData, 'email', 'contactEmail', 'emailAddress') : (document.getElementById('visitorEmail') ? document.getElementById('visitorEmail').value : null);
    const bookingId = bookingData ? safe(bookingData, 'ref', 'bookingRef', 'bookingId') : null;
    const amount = bookingData ? safe(bookingData, 'bookingPrice', 'price', 'amount') : null;
    // optional message/note element (if present on your page)
    const messageEl = document.getElementById('receiptNote');
    const message = messageEl ? messageEl.value : null;

    const payload = {
      filename: file.name,
      mime: file.type || 'application/octet-stream',
      b64: b64,
      adminEmail: adminEmail,
      // the fields your Apps Script uses:
      visitorName: visitorName,
      visitorEmail: visitorEmail,
      bookingId: bookingId,
      amount: amount,
      message: message
    };

    // Remove null entries to keep payload tidy
    Object.keys(payload).forEach(k => { if (payload[k] === null || payload[k] === undefined) delete payload[k]; });

    uploadStatus.className = 'upload-status';
    uploadStatus.textContent = 'Uploading...';

    try{
      const resp = await fetch(UPLOAD_SCRIPT_URL, { method:'POST', body:JSON.stringify(payload) });
      const text = await resp.text();
      // Optionally you can parse JSON if your Apps Script returns JSON
      let ok = true;
      try { const j = JSON.parse(text); if (j && j.ok === false) ok = false; } catch(e) {/* not JSON, ignore */}
      if (ok) {
        uploadStatus.className = 'upload-status success';
        uploadStatus.textContent = 'Your receipt has successfully been uploaded for verification. On confirmation an email will be sent to you containing your booking receipt which you will use to gain access to the event venue on the scheduled date of the event';
      } else {
        uploadStatus.className = 'upload-status error';
        uploadStatus.textContent = 'Upload returned an error: ' + text;
        console.error('Upload error', text);
      }
    }catch(err){
      uploadStatus.className = 'upload-status error';
      uploadStatus.textContent = 'Upload failed: ' + err;
      console.error(err);
    }
  };
  reader.readAsDataURL(file);
}

uploadBtn.addEventListener('click', uploadSelectedFile);

// Fetch booking + preload instructions
const ref = new URLSearchParams(window.location.search).get('id');
function preloadInstructions() {
  const promises = methodsOrder.map(method => fetch(`${PAYMENT_API}?action=getPaymentDetails&method=${encodeURIComponent(method)}`)
    .then(r=>r.json())
    .then(d=>{methodInstructions[method]=(d && d.success && d.details)?d.details:`${method} payment method unavailable.`;})
    .catch(()=>{methodInstructions[method]=`${method} payment method unavailable.`;}));
  return Promise.all(promises);
}
function fetchBooking() {
  if(!ref){ document.getElementById('bookingDetails').innerHTML="<div style='color:red;padding:12px;border-radius:8px;background:#fff4f4;border:1px solid #f2cece'>No booking reference found.</div>"; return Promise.resolve(); }
  return fetch(`${BOOKING_API}?id=${encodeURIComponent(ref)}`).then(r=>r.json()).then(d=>{if(!d||!d.success)throw new Error('No booking'); bookingData=d.booking; renderBookingDetails(bookingData);}).catch(()=>{document.getElementById('bookingDetails').innerHTML="<div style='color:red;padding:12px;border-radius:8px;background:#fff4f4;border:1px solid #f2cece'>Error loading booking details.</div>";});
}

Promise.all([fetchBooking(),preloadInstructions()]).then(()=>{
  const defaultBtn = methodButtons.find(b=>b.dataset.method.toLowerCase()==='paypal');
  if(defaultBtn) setActiveMethod(defaultBtn);
  document.querySelectorAll('.method-btn,.instructions').forEach(el=>{el.style.animation='none';el.style.opacity='1'});
});
</script>

</body>
</html>
